<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Text2 Note</title>
  <!-- Google tag (gtag.js) - GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6J85STMJ14');
</script>
  <meta name="google" content="notranslate">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="description" content="text2 - note: A simple and elegant note-taking app by text2. Access it at https://note.text2.click.">
  <meta name="keywords" content="text2, note, text2 - note, note-taking app, text2 brand">
  <meta property="og:title" content="text2 - note">
  <meta property="og:description" content="A simple and elegant note-taking app by text2. Access it at https://note.text2.click.">
  <meta property="og:url" content="https://note.text2.click">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/android-chrome-512x512.png">
  <link rel="canonical" href="https://note.text2.click">
  <style>
    :root{
      --radius: 16px;
      --gap: 16px;
      --maxwidth: 880px;
      --font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      --accent: #8A2BE2; /* A vibrant purple */
      --accent-light: #9932CC;
      --accent-glow: rgba(138, 43, 226, 0.3);

      /* Light Theme */
      --bg-light: #f4f4f8;
      --card-bg-light: rgba(255, 255, 255, 0.45);
      --border-light: rgba(255, 255, 255, 0.6);
      --text-light: #1a1a2e;
      --muted-light: #6a6a8b;
      --subtle-light: rgba(230, 230, 250, 0.5);
      --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }
    
    [data-theme="dark"]{
      /* Dark Theme */
      --bg-dark: #12121a;
      --card-bg-dark: rgba(30, 30, 45, 0.55);
      --border-dark: rgba(255, 255, 255, 0.15);
      --text-dark: #e0e0fc;
      --muted-dark: #9a9ac8;
      --subtle-dark: rgba(40, 40, 60, 0.7);
      --shadow-dark: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    [data-theme="light"] {
        --bg: var(--bg-light);
        --card-bg: var(--card-bg-light);
        --border-color: var(--border-light);
        --text-color: var(--text-light);
        --muted-color: var(--muted-light);
        --subtle-bg: var(--subtle-light);
        --shadow: var(--shadow-light);
    }

    [data-theme="dark"] {
        --bg: var(--bg-dark);
        --card-bg: var(--card-bg-dark);
        --border-color: var(--border-dark);
        --text-color: var(--text-dark);
        --muted-color: var(--muted-dark);
        --subtle-bg: var(--subtle-dark);
        --shadow: var(--shadow-dark);
    }
    
    *{box-sizing:border-box}
    
    html,body{height:100%; font-family: var(--font-family);}
    
    body{
      margin:0; 
      background-color: var(--bg); 
      color: var(--text-color); 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      padding:24px;
      overflow: hidden;
      transition: background-color 0.3s ease;
    }

    /* Animated Gradient Background */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: -1;
      background: radial-gradient(circle at 15% 25%, #8A2BE2, transparent 30%),
                  radial-gradient(circle at 85% 75%, #4158D0, transparent 40%),
                  radial-gradient(circle at 50% 50%, #FF2525, transparent 35%);
      filter: blur(120px);
      transform: scale(1.2);
      animation: rotate-gradient 30s ease-in-out infinite;
    }

    @keyframes rotate-gradient {
      0% { transform: scale(1.2) rotate(0deg); }
      50% { transform: scale(1.4) rotate(180deg); }
      100% { transform: scale(1.2) rotate(360deg); }
    }
    
    .app{
      width:100%; 
      max-width:var(--maxwidth); 
      background:transparent;
      display:grid; 
      grid-template-columns:1fr; 
      gap:var(--gap);
    }

    /* Main Glass Shell */
    .shell{
      background: var(--card-bg);
      backdrop-filter: blur(25px) saturate(180%); 
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      border-radius: 24px; 
      box-shadow: var(--shadow); 
      overflow:hidden; 
      display:flex; 
      flex-direction:column; 
      min-height:560px; 
      max-height:90vh; 
      border: 1px solid var(--border-color);
      transition: background 0.3s, border 0.3s;
    }

    /* Toolbar */
    .toolbar-wrapper{
      position:sticky; 
      top:0; 
      background: var(--card-bg); 
      backdrop-filter:blur(25px) saturate(180%); 
      -webkit-backdrop-filter:blur(25px) saturate(180%); 
      z-index:10; 
      border-bottom: 1px solid var(--border-color);
      padding: 8px 0;
    }
    
    .toolbar{
      display:flex; 
      gap:8px; 
      padding: 8px 16px; 
      align-items:center; 
      justify-content:center; 
      background:transparent;
    }
    
    .tab-btn, .icon-btn {
      background: transparent;
      border: 1px solid transparent;
      padding: 8px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-color);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease-in-out;
    }

    .tab-btn:hover, .icon-btn:hover {
        background: var(--subtle-bg);
        border-color: var(--border-color);
        transform: translateY(-2px);
    }
    
    .tab-btn.active{
      background: var(--accent); 
      color: white; 
      box-shadow: 0 4px 20px var(--accent-glow);
      border-color: var(--accent-light);
    }

    .toolbar .spacer{flex:1}
    
    .theme-toggle{
      min-width:44px; 
      height: 40px; 
      justify-content:center;
      font-size: 22px;
    }

    .content{
      display:grid; 
      grid-template-columns:1fr; 
      gap:16px; 
      padding:18px; 
      flex:1; 
      overflow-y:auto; 
      max-height:calc(90vh - 140px);
    }
    /* Custom Scrollbar for a modern look */
    .content::-webkit-scrollbar { width: 6px; }
    .content::-webkit-scrollbar-track { background: transparent; }
    .content::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    .content::-webkit-scrollbar-thumb:hover { background: var(--accent-light); }

    .editor{display:flex; flex-direction:column; gap:12px}
    .field{display:flex; flex-direction:column; gap:8px}

    input.title, .rte-area, .search {
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      font-size: 16px;
      background: var(--subtle-bg);
      color: var(--text-color);
      transition: all 0.2s ease-in-out;
      width: 100%;
    }
    input.title::placeholder, .rte-area::placeholder, .search::placeholder {
      color: var(--muted-color);
    }
    input.title:focus, .rte-area:focus, .search:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-glow);
        background: var(--card-bg);
    }

    .rte-toolbar{
      display:flex; 
      gap:8px; 
      align-items:center; 
      flex-wrap:wrap; 
      position:sticky; 
      top: -10px; /* Adjust for better positioning */
      background:var(--card-bg); 
      backdrop-filter:blur(10px); 
      -webkit-backdrop-filter:blur(10px); 
      z-index:4; 
      padding:8px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
    }

    .rte-area{
      min-height:260px; 
      resize:vertical; 
      line-height:1.6;
    }
    
    .rte-area img{max-width:100%; height:auto; border-radius:10px}
    
    .row{display:flex; gap:12px; align-items:center}
    
    .btn{
      padding:12px 20px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-weight:700;
      font-size: 14px;
      transition: all 0.2s ease-in-out;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn.save{
      background: var(--accent); 
      color: white; 
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .btn.save:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px var(--accent-glow);
    }
    
    .btn.clear{
      background: var(--subtle-bg);
      color: var(--muted-color); 
      border: 1px solid var(--border-color);
    }
     .btn.clear:hover {
        background: var(--card-bg);
        color: var(--text-color);
    }

    .notes-list{display:flex; flex-direction:column; gap:12px}
    
    .note-card{
      background: var(--subtle-bg); 
      border-radius: var(--radius); 
      padding: 16px; 
      border: 1px solid var(--border-color); 
      cursor:pointer; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      transition: all 0.2s ease-in-out;
    }
    .note-card:hover {
        transform: scale(1.02);
        box-shadow: var(--shadow);
        border-color: var(--accent);
    }
    
    .note-meta{display:flex; flex-direction:column}
    .note-title{font-weight:700; font-size: 16px; margin-bottom: 4px;}
    .note-time{color:var(--muted-color); font-size:13px}
    .note-actions{display:flex; gap:8px; align-items:center}
    
    .icon-glass {
      background: var(--subtle-bg);
      border: 1px solid var(--border-color);
    }
    
    .icon-btn ion-icon{font-size:20px; vertical-align:middle}

    .empty{padding:48px; text-align:center; color:var(--muted-color); font-size: 16px;}
    .empty::before {
      content: '📝';
      font-size: 48px;
      display: block;
      margin-bottom: 16px;
      opacity: 0.5;
    }


    /* Responsive adjustments */
    @media (min-width:768px){
      .shell{min-height:520px; max-height:85vh}
      .toolbar{justify-content:flex-start;padding:12px 24px}
      .content{max-height:calc(85vh - 120px)}
    }
    
    @media (max-width:767px){
      body{padding:0}
      .app { height: 100vh; }
      .shell{max-height:100vh; height: 100%; border-radius: 0;}
      .content{max-height:calc(100vh - 100px)}
    }

    /* Footer */
    footer.hint{
        padding:12px 18px; 
        font-size:13px; 
        color:var(--muted-color); 
        display:flex; 
        justify-content:space-between; 
        align-items:center;
        border-top: 1px solid var(--border-color);
        background: var(--card-bg);
    }
    
    /* Dropdown Menus */
    .export-dropdown, .color-dropdown {position:relative; display:inline-block}
    
    .export-menu, .color-menu {
      position:absolute; 
      top:110%; 
      left:0; 
      min-width:180px; 
      background:var(--card-bg); 
      border:1px solid var(--border-color); 
      border-radius: 12px; 
      box-shadow:var(--shadow); 
      backdrop-filter:blur(20px) saturate(180%); 
      -webkit-backdrop-filter:blur(20px) saturate(180%); 
      z-index:20; 
      overflow:hidden; 
      margin-top:4px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
    }
    
    .export-menu.show, .color-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .export-option{
      width:100%; padding:12px 16px; border:none; background:transparent; 
      color:var(--text-color); text-align:left; cursor:pointer; font-size:14px; 
      display:flex; align-items:center; gap:8px; font-weight:500;
      transition: background 0.2s ease;
    }
    
    .export-option:hover{background:var(--subtle-bg)}
    .export-option ion-icon{font-size:18px}
    
    .color-menu{ min-width: 220px; padding: 12px; }
    .color-section{margin-bottom:12px}
    .color-section:last-child{margin-bottom:0}
    .color-section-title{font-size:12px; color:var(--muted-color); margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px}
    .color-grid{display:grid; grid-template-columns:repeat(6, 1fr); gap:6px}
    .color-option{
      width:28px; height:28px; border-radius:8px; cursor:pointer; border:2px solid transparent;
      display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px;
      transition:all 0.2s ease; position:relative;
    }
    .color-option:hover{transform:scale(1.1); border-color:var(--accent)}
    .color-option.active{border-color:var(--accent); box-shadow:0 0 0 2px var(--accent-glow)}
    .color-custom{
      grid-column:span 2; background:linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3);
      color:white; font-size:11px; text-align:center; padding:4px;
    }

    /* Modals */
    .image-modal{
      position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.3); 
      display:none; 
      z-index:1000; 
      justify-content:center; align-items:center; 
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s;
    }
    
    .image-modal.show{
      display:flex;
      opacity: 1;
      visibility: visible;
    }
    
    .image-modal-content{
      background: var(--card-bg); 
      border-radius: 20px; 
      padding:24px; 
      max-width:500px; width:90%; max-height:80vh; overflow-y:auto;
      border:1px solid var(--border-color); 
      box-shadow:var(--shadow);
      backdrop-filter:blur(25px) saturate(180%); 
      -webkit-backdrop-filter:blur(25px) saturate(180%);
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .image-modal.show .image-modal-content {
      transform: scale(1);
    }

    .image-modal-header{
      font-size:18px; font-weight:700; margin-bottom:16px; color:var(--text-color);
      display:flex; justify-content:space-between; align-items:center;
    }
    
    .image-modal-close{
      background:transparent; border:none; font-size:24px; cursor:pointer; 
      color:var(--muted-color); padding:4px; border-radius:8px;
    }
    
    .image-modal-close:hover{background:var(--subtle-bg)}
    .image-preview{
      width:100%; max-width:400px; margin:16px auto; display:block; 
      border-radius:8px; border:1px solid var(--border-color);
    }
    .resize-controls{margin:16px 0; display:flex; flex-direction:column; gap:12px}
    .resize-row{display:flex; gap:12px; align-items:center}
    .resize-label{font-weight:600; color:var(--text-color); min-width:80px}
    
    .resize-slider{flex:1; height:6px; border-radius:3px; background:var(--border-color); 
      outline:none; -webkit-appearance:none; cursor:pointer}
    .resize-slider::-webkit-slider-thumb{
      -webkit-appearance:none; width:18px; height:18px; border-radius:50%; 
      background:var(--accent); cursor:pointer; box-shadow:0 2px 6px var(--accent-glow);
    }
    .resize-slider::-moz-range-thumb{
      width:18px; height:18px; border-radius:50%; background:var(--accent); 
      cursor:pointer; border:none; box-shadow:0 2px 6px var(--accent-glow);
    }
    .resize-value{color:var(--muted-color); font-weight:600; min-width:60px; text-align:right}
    .size-presets{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .size-preset{
      background:var(--subtle-bg); border:1px solid var(--border-color); 
      padding:6px 12px; border-radius:8px; cursor:pointer; font-size:12px; 
      color:var(--text-color); font-weight:600; transition:all 0.2s ease;
    }
    .size-preset:hover{background:var(--accent); color:white; border-color:var(--accent)}
    .modal-actions{display:flex; gap:12px; justify-content:flex-end; margin-top:20px}
    .modal-btn{
      padding:10px 16px; border-radius:10px; border:none; cursor:pointer; 
      font-weight:600; transition:all 0.2s ease;
    }
    .modal-btn.primary{
      background:var(--accent); color:white; box-shadow:0 4px 12px var(--accent-glow);
    }
    .modal-btn.primary:hover{transform:translateY(-1px); box-shadow:0 6px 16px var(--accent-glow)}
    .modal-btn.secondary{
      background:var(--subtle-bg); color:var(--text-color); border:1px solid var(--border-color);
    }
    .modal-btn.secondary:hover{background:var(--border-color)}
  </style>
</head>
<body data-theme="dark"> <!-- Start with dark theme as default -->
  <div class="app">
    <div class="shell" id="appShell">
      <div class="toolbar-wrapper">
        <div class="toolbar" role="toolbar">
          <button id="tab-edit" class="tab-btn active" aria-pressed="true"><ion-icon name="create-outline"></ion-icon> Note</button>
          <button id="tab-list" class="tab-btn" aria-pressed="false"><ion-icon name="list-outline"></ion-icon> Saved</button>
          <div class="spacer"></div>
          <button id="open-file-btn" class="icon-btn" title="Open File"><ion-icon name="folder-open-outline"></ion-icon></button>
          <input id="file-input" type="file" accept=".docx,.doc" style="display:none" />
          <div class="export-dropdown">
            <button id="export-btn" class="icon-btn" title="Export Notes"><ion-icon name="download-outline"></ion-icon></button>
            <div class="export-menu" id="export-menu">
              <button id="export-docx" class="export-option"><ion-icon name="document-text-outline"></ion-icon>DOCX</button>
              <button id="export-pdf" class="export-option"><ion-icon name="document-outline"></ion-icon>PDF</button>
            </div>
          </div>
          <button id="themeToggle" class="icon-btn theme-toggle" title="Light/Dark Mode"><ion-icon id="themeIcon" name="sunny-outline"></ion-icon></button>
        </div>
      </div>

      <div class="content">
        <!-- Editor view -->
        <div id="view-editor" class="editor" aria-hidden="false">
          <div class="field">
            <input id="note-title" class="title" placeholder="Tiêu đề..." />
          </div>
          <div class="field rte-box">
             <div class="rte-toolbar" aria-label="Formatting">
              <button id="btnBold" class="icon-btn" type="button" title="Bold (Ctrl/Cmd+B)"><ion-icon name="text-outline" style="font-weight: bold;"></ion-icon></button>
              <button id="btnItalic" class="icon-btn" type="button" title="Italic (Ctrl/Cmd+I)"><ion-icon name="text-outline" style="font-style: italic;"></ion-icon></button>
              <button id="btnUnderline" class="icon-btn" type="button" title="Underline (Ctrl/Cmd+U)"><ion-icon name="text-outline" style="text-decoration: underline;"></ion-icon></button>
              <input id="imgInput" type="file" accept="image/*" style="display:none" />
              <button id="btnImage" class="icon-btn" type="button" title="Insert Image"><ion-icon name="image-outline"></ion-icon></button>
              <div class="color-dropdown">
                <button id="btnColor" class="icon-btn" type="button" title="Text Color"><ion-icon name="color-palette-outline"></ion-icon></button>
                <div class="color-menu" id="color-menu">
                  <div class="color-section">
                    <div class="color-section-title">Quick Colors</div>
                    <div class="color-grid">
                      <div class="color-option" data-color="#E0E0FC" style="background-color: #E0E0FC; color: black;" title="White (Dark Mode Text)">A</div>
                      <div class="color-option" data-color="#1A1A2E" style="background-color: #1A1A2E; color: white;" title="Black (Light Mode Text)">A</div>
                      <div class="color-option" data-color="#FF6B6B" style="background-color: #FF6B6B; color: white;" title="Red">A</div>
                      <div class="color-option" data-color="#4DDB6A" style="background-color: #4DDB6A; color: white;" title="Green">A</div>
                      <div class="color-option" data-color="#54A0FF" style="background-color: #54A0FF; color: white;" title="Blue">A</div>
                      <div class="color-option" data-color="#FFD166" style="background-color: #FFD166; color: white;" title="Yellow">A</div>
                    </div>
                  </div>
                   <div class="color-section">
                    <div class="color-section-title">Custom Color</div>
                    <div class="color-grid">
                      <div class="color-option color-custom" id="customColorBtn" title="Choose Custom Color">Custom</div>
                      <input id="colorInput" type="color" value="#E0E0FC" style="display:none" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="note-body" class="rte-area" contenteditable="true" aria-multiline="true" role="textbox" placeholder="Bắt đầu viết nào... (Ctrl/Cmd+S để lưu nhanh)"></div>
          </div>
          <div class="row">
            <button id="saveBtn" class="btn save"><ion-icon name="save-outline"></ion-icon> LƯU GHI CHÚ</button>
            <button id="clearBtn" class="btn clear">Xóa</button>
            <div style="flex:1"></div>
            <div class="note-count" id="noteCount" style="color: var(--muted-color); font-size: 14px;"></div>
          </div>
        </div>

        <!-- List view -->
        <div id="view-list" class="notes-list" style="display:none;" aria-hidden="true">
          <div style="display:flex; gap:8px; align-items:center">
            <input id="searchInput" class="search" placeholder="Tìm kiếm theo tiêu đề hoặc nội dung..." />
            <button id="clearAll" class="btn clear">Xóa tất cả</button>
          </div>
          <div id="notesContainer"></div>
          <div id="emptyMsg" class="empty" style="display:none">Chưa có ghi chú nào. Tạo một cái đi! 💡</div>
        </div>
      </div>

      <footer class="hint">
        <div>Cảm ơn đã dùng text2 note</div>
        <div style="font-style:italic">Note now</div>
      </footer>
    </div>
  </div>

  <!-- Image Resize Modal -->
  <div class="image-modal" id="imageModal">
    <div class="image-modal-content">
      <div class="image-modal-header">
        <span>Chỉnh sửa ảnh</span>
        <button class="image-modal-close" id="imageModalClose">&times;</button>
      </div>
      <img class="image-preview" id="imagePreview" src="" alt="Preview">
      <div class="resize-controls">
        <div class="resize-row">
          <label class="resize-label">Width:</label>
          <input type="range" class="resize-slider" id="widthSlider" min="50" max="800" value="300">
          <span class="resize-value" id="widthValue">300px</span>
        </div>
        <div class="resize-row">
          <label class="resize-label">Height:</label>
          <input type="range" class="resize-slider" id="heightSlider" min="50" max="600" value="200">
          <span class="resize-value" id="heightValue">200px</span>
        </div>
        <div class="size-presets">
          <button class="size-preset" data-width="150" data-height="100">Small</button>
          <button class="size-preset" data-width="300" data-height="200">Medium</button>
          <button class="size-preset" data-width="500" data-height="350">Large</button>
          <button class="size-preset" data-width="100" data-height="100">Square</button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" id="cancelResize">Hủy</button>
        <button class="modal-btn primary" id="confirmResize">Chèn ảnh</button>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <script>
    // --- App Logic (Unchanged except for minor fixes and enhancements) ---
    const KEY = 'simple_notes_v2'; // Changed key to avoid conflict with old version
    let notes = [];
    let editingId = null;

    // DOM Elements
    const bodyEl = document.body;
    const tabEdit = document.getElementById('tab-edit');
    const tabList = document.getElementById('tab-list');
    const viewEditor = document.getElementById('view-editor');
    const viewList = document.getElementById('view-list');
    const titleInput = document.getElementById('note-title');
    const bodyInput = document.getElementById('note-body');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const notesContainer = document.getElementById('notesContainer');
    const emptyMsg = document.getElementById('emptyMsg');
    const noteCount = document.getElementById('noteCount');
    const searchInput = document.getElementById('searchInput');
    const clearAll = document.getElementById('clearAll');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const btnBold = document.getElementById('btnBold');
    const btnItalic = document.getElementById('btnItalic');
    const btnUnderline = document.getElementById('btnUnderline');
    const btnImage = document.getElementById('btnImage');
    const imgInput = document.getElementById('imgInput');
    const btnColor = document.getElementById('btnColor');
    const colorMenu = document.getElementById('color-menu');
    const colorOptions = document.querySelectorAll('.color-option');
    const customColorBtn = document.getElementById('customColorBtn');
    const colorInput = document.getElementById('colorInput');
    const exportBtn = document.getElementById('export-btn');
    const exportMenu = document.getElementById('export-menu');
    const exportDocx = document.getElementById('export-docx');
    const exportPdf = document.getElementById('export-pdf');
    const openFileBtn = document.getElementById('open-file-btn');
    const fileInput = document.getElementById('file-input');
    const imageModal = document.getElementById('imageModal');
    let currentImageForResize = null;


    function load(){
      try{ notes = JSON.parse(localStorage.getItem(KEY) || '[]'); }
      catch(e){ notes = []; }
      renderNotesList();
      updateCount();
    }

    function saveToStorage(){ localStorage.setItem(KEY, JSON.stringify(notes)); }
    function makeId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

    function saveNote(){
      const title = titleInput.value.trim();
      const body = (bodyInput.innerHTML || '').trim();
      if(!title && !body){
        // Using a custom, non-blocking notification would be better
        alert('Vui lòng viết gì đó trước khi lưu nhé 🙂'); return 
      }
      if(editingId){
        const i = notes.findIndex(n => n.id === editingId);
        if(i > -1){ notes[i] = {...notes[i], title, body, updated: Date.now()}; }
      } else {
        notes.unshift({ id: makeId(), title, body, created: Date.now(), updated: Date.now(), pinned:false });
      }
      saveToStorage();
      renderNotesList();
      updateCount();
      clearEditor();
      showList(); // show saved notes after save
    }
    
    function renderNotesList(filter=''){
      notesContainer.innerHTML = '';
      const f = filter.toLowerCase().trim();
      const list = notes
        .filter(n => {
          if(!f) return true;
          const content = n.title.toLowerCase() + ' ' + n.body.replace(/<[^>]*>/g, '').toLowerCase();
          return content.includes(f);
        })
        .sort((a,b)=> (b.pinned===true) - (a.pinned===true) || (b.updated||0) - (a.updated||0));
        
      emptyMsg.style.display = list.length === 0 ? 'block' : 'none';
      
      list.forEach(n => {
        const card = document.createElement('div'); card.className='note-card';
        const meta = document.createElement('div'); meta.className='note-meta';
        const t = document.createElement('div'); t.className='note-title'; t.textContent = n.title || '(Không có tiêu đề)';
        const s = document.createElement('div'); s.className='note-time'; s.textContent = new Date(n.updated || n.created).toLocaleString('vi-VN');
        meta.appendChild(t); meta.appendChild(s);
        
        const actions = document.createElement('div'); actions.className='note-actions';
        
        const pinBtn = document.createElement('button'); pinBtn.className='icon-btn icon-glass'; pinBtn.title='Ghim / Bỏ ghim'; pinBtn.innerHTML = n.pinned ? '<ion-icon name="bookmark"></ion-icon>' : '<ion-icon name="bookmark-outline"></ion-icon>';
        pinBtn.onclick = (e)=>{ e.stopPropagation(); togglePin(n.id); };

        const delBtn = document.createElement('button'); delBtn.className='icon-btn icon-glass'; delBtn.title='Xóa'; delBtn.innerHTML='<ion-icon name="trash-outline"></ion-icon>';
        delBtn.onclick = (e)=>{ e.stopPropagation(); if(confirm('Bạn chắc chắn muốn xóa ghi chú này?')){ deleteNote(n.id); } }
        
        actions.appendChild(pinBtn); actions.appendChild(delBtn);
        card.appendChild(meta); card.appendChild(actions);
        card.onclick = ()=>{ openNote(n.id); }
        notesContainer.appendChild(card);
      });
    }

    function openNote(id){
      const n = notes.find(x=>x.id===id); if(!n) return;
      editingId = id;
      titleInput.value = n.title; bodyInput.innerHTML = n.body;
      showEditor();
    }

    function deleteNote(id){ 
      notes = notes.filter(n=>n.id!==id); 
      saveToStorage(); 
      renderNotesList(searchInput.value); 
      updateCount(); 
    }

    function clearEditor(){ 
      editingId=null; 
      titleInput.value=''; 
      bodyInput.innerHTML=''; 
    }

    function updateCount(){ 
      noteCount.textContent = notes.length > 0 ? `${notes.length} ghi chú` : 'Chưa có ghi chú'; 
    }

    // Tabs
    function switchTab(activeTab) {
        if (activeTab === 'edit') {
            tabEdit.classList.add('active');
            tabEdit.setAttribute('aria-pressed', 'true');
            tabList.classList.remove('active');
            tabList.setAttribute('aria-pressed', 'false');
            showEditor();
        } else {
            tabList.classList.add('active');
            tabList.setAttribute('aria-pressed', 'true');
            tabEdit.classList.remove('active');
            tabEdit.setAttribute('aria-pressed', 'false');
            showList();
        }
    }
    tabEdit.addEventListener('click', () => switchTab('edit'));
    tabList.addEventListener('click', () => switchTab('list'));
    
    function showEditor(){ 
      viewEditor.style.display='flex'; 
      viewEditor.setAttribute('aria-hidden','false'); 
      viewList.style.display='none'; 
      viewList.setAttribute('aria-hidden','true'); 
      titleInput.focus(); 
    }

    function showList(){ 
      viewEditor.style.display='none'; 
      viewEditor.setAttribute('aria-hidden','true'); 
      viewList.style.display='flex'; 
      viewList.setAttribute('aria-hidden','false'); 
      searchInput.focus(); 
    }

    // Events
    saveBtn.addEventListener('click', saveNote);
    clearBtn.addEventListener('click', ()=>{ if(titleInput.value || bodyInput.innerHTML) { if(confirm('Nội dung hiện tại sẽ bị xóa?')) clearEditor(); } else { clearEditor(); } });
    searchInput.addEventListener('input', ()=>{ renderNotesList(searchInput.value); });
    clearAll.addEventListener('click', ()=>{ if(notes.length > 0 && confirm('Bạn chắc chắn muốn xóa TẤT CẢ ghi chú?')){ notes=[]; saveToStorage(); renderNotesList(); updateCount(); } });

    // Theme
    const THEME_KEY = 'simple_notes_theme_v2';
    function applyTheme(theme){
      bodyEl.setAttribute('data-theme', theme);
      localStorage.setItem(THEME_KEY, theme);
      if(themeIcon){ themeIcon.setAttribute('name', theme==='dark' ? 'sunny-outline' : 'moon-outline'); }
    }
    const savedTheme = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(savedTheme);
    themeToggle.addEventListener('click', ()=>{
      const next = bodyEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    });

    // RTE Commands
    function exec(cmd, value = null){ document.execCommand(cmd, false, value); bodyInput.focus(); }
    btnBold.addEventListener('click', ()=> exec('bold'));
    btnItalic.addEventListener('click', ()=> exec('italic'));
    btnUnderline.addEventListener('click', ()=> exec('underline'));
    btnImage.addEventListener('click', ()=> imgInput.click());

    // --- New Color Picker Logic ---
    btnColor.addEventListener('click', (e) => {
        e.stopPropagation();
        colorMenu.classList.toggle('show');
    });

    colorOptions.forEach(option => {
        option.addEventListener('click', (e) => {
            const color = e.currentTarget.dataset.color;
            if (color) {
                exec('foreColor', color);
                colorMenu.classList.remove('show');
            }
        });
    });

    customColorBtn.addEventListener('click', () => {
        colorInput.click();
    });

    colorInput.addEventListener('input', (e) => {
        exec('foreColor', e.target.value);
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!exportBtn.contains(e.target) && !exportMenu.contains(e.target)) {
        exportMenu.classList.remove('show');
      }
      if (!btnColor.contains(e.target) && !colorMenu.contains(e.target)) {
        colorMenu.classList.remove('show');
      }
    });

    // --- Image Resizing Modal Logic ---
    const widthSlider = document.getElementById('widthSlider');
    const heightSlider = document.getElementById('heightSlider');
    const widthValue = document.getElementById('widthValue');
    const heightValue = document.getElementById('heightValue');
    const imagePreview = document.getElementById('imagePreview');
    const sizePresets = document.querySelectorAll('.size-preset');

    function openImageModal(imageSrc) {
        currentImageForResize = imageSrc;
        imagePreview.src = imageSrc;
        imageModal.classList.add('show');
    }

    function closeImageModal() {
        imageModal.classList.remove('show');
        currentImageForResize = null;
        imgInput.value = ''; // Reset file input
    }
    
    imgInput.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            openImageModal(event.target.result);
        };
        reader.readAsDataURL(file);
    });

    widthSlider.addEventListener('input', () => widthValue.textContent = `${widthSlider.value}px`);
    heightSlider.addEventListener('input', () => heightValue.textContent = `${heightSlider.value}px`);

    sizePresets.forEach(btn => {
        btn.addEventListener('click', () => {
            widthSlider.value = btn.dataset.width;
            heightSlider.value = btn.dataset.height;
            widthValue.textContent = `${btn.dataset.width}px`;
            heightValue.textContent = `${btn.dataset.height}px`;
        });
    });

    document.getElementById('imageModalClose').addEventListener('click', closeImageModal);
    document.getElementById('cancelResize').addEventListener('click', closeImageModal);
    
    document.getElementById('confirmResize').addEventListener('click', () => {
        if (!currentImageForResize) return;

        const img = document.createElement('img');
        img.src = currentImageForResize;
        img.style.width = `${widthSlider.value}px`;
        img.style.height = `${heightSlider.value}px`;
        img.style.maxWidth = '100%';
        img.style.objectFit = 'contain';
        img.style.borderRadius = '10px';
        img.style.resize = 'both';
        img.style.overflow = 'hidden';
        img.style.border = '1px solid var(--border-color)';
        
        bodyInput.focus();
        exec('insertHTML', img.outerHTML + '&nbsp;'); // Add space after for easier typing
        closeImageModal();
    });


    // Pin
    function togglePin(id){
      const i = notes.findIndex(n=>n.id===id);
      if(i>-1){ 
        notes[i].pinned = !notes[i].pinned; 
        notes[i].updated = Date.now(); 
        saveToStorage(); 
        renderNotesList(searchInput.value||''); 
      }
    }

    // Keyboard shortcut
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
        e.preventDefault(); saveNote();
      }
    });

    // Export
    if(exportBtn && exportMenu) {
      exportBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        exportMenu.classList.toggle('show');
      });
    }

    if(exportDocx) exportDocx.addEventListener('click', () => { exportMenu.classList.remove('show'); exportToDocx(); });
    if(exportPdf) exportPdf.addEventListener('click', () => { exportMenu.classList.remove('show'); exportToPdf(); });

    function exportToDocx() {
      const title = titleInput.value.trim() || 'Không có tiêu đề';
      const body = bodyInput.innerHTML || '';
      if (!body) return alert('Không có nội dung để xuất.');
      
      const htmlContent = `<h1>${title}</h1><div>${body}</div>`;
      const blob = window.htmlDocx.asBlob(htmlContent);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${title}.docx`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportToPdf() {
      const title = titleInput.value.trim() || 'Không có tiêu đề';
      const body = bodyInput.innerHTML || '';
      if (!body) return alert('Không có nội dung để xuất.');
      
      // Create a temporary element for PDF generation to control styling
      const element = document.createElement('div');
      element.style.padding = '20px';
      element.style.fontFamily = 'Arial';
      element.innerHTML = `<h1>${title}</h1><div>${body}</div>`;

      const opt = {
        margin:       1,
        filename:     `${title}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(element).save();
    }

    // Open File
    if(openFileBtn && fileInput) {
      openFileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', function(event) {
        const file = this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          mammoth.convertToHtml({arrayBuffer: e.target.result})
            .then(result => {
              bodyInput.innerHTML = result.value;
              titleInput.value = file.name.replace(/\.[^/.]+$/, "");
              showEditor();
            })
            .catch(err => {
                console.error(err);
                alert('Không thể đọc file .docx này.');
            });
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
      });
    }

    // --- Init ---
    load();
    switchTab('edit'); // Start on editor view
  </script>
</body>
</html>


